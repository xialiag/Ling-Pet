# æ¡Œå® å·¥å…·ç³»ç»Ÿ

## æ¦‚è¿°

æ¡Œå® å·¥å…·ç³»ç»Ÿè®©æ¡Œå®  LLM èƒ½å¤Ÿè°ƒç”¨æ’ä»¶æä¾›çš„å·¥å…·æ¥å®Œæˆç”¨æˆ·çš„è¯·æ±‚ã€‚

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ¡Œå®  LLM                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç³»ç»Ÿæç¤ºè¯ + å·¥å…·åˆ—è¡¨          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç”¨æˆ·æ¶ˆæ¯                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LLM ç”Ÿæˆå“åº”                   â”‚    â”‚
â”‚  â”‚  (å¯èƒ½åŒ…å«å·¥å…·è°ƒç”¨)             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PetToolManager                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è§£æå·¥å…·è°ƒç”¨                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ‰§è¡Œå·¥å…·                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è¿”å›ç»“æœ                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ’ä»¶å·¥å…·                         â”‚
â”‚  - search_local_emoji                   â”‚
â”‚  - download_emoji_suit                  â”‚
â”‚  - send_emoji                           â”‚
â”‚  - ...                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½¿ç”¨æµç¨‹

### 1. æ’ä»¶æ³¨å†Œå·¥å…·

æ’ä»¶é€šè¿‡ `context.registerTool()` æ³¨å†Œå·¥å…·ï¼š

```typescript
export default definePlugin({
  name: 'bilibili-emoji',
  
  async onLoad(context) {
    // æ³¨å†Œå·¥å…·
    context.registerTool({
      name: 'search_local_emoji',
      description: 'æœç´¢æœ¬åœ°å·²ä¸‹è½½çš„è¡¨æƒ…åŒ…',
      category: 'emoji',
      parameters: [
        {
          name: 'query',
          type: 'string',
          description: 'æœç´¢å…³é”®è¯',
          required: true
        },
        {
          name: 'limit',
          type: 'number',
          description: 'è¿”å›ç»“æœæ•°é‡',
          required: false
        }
      ],
      handler: async (query: string, limit: number = 10) => {
        // å®ç°æœç´¢é€»è¾‘
        return {
          count: 5,
          emojis: [...]
        }
      }
    })
  }
})
```

### 2. ç”Ÿæˆå·¥å…·æç¤ºè¯

åœ¨æ¡Œå®  LLM çš„ç³»ç»Ÿæç¤ºè¯ä¸­æ³¨å…¥å·¥å…·åˆ—è¡¨ï¼š

```typescript
import { getPetToolPrompt } from '@/pluginLoader/init'

// è·å–å·¥å…·æç¤ºè¯
const toolPrompt = getPetToolPrompt()

// æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯
const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªå¯çˆ±çš„æ¡Œå® åŠ©æ‰‹ã€‚

${toolPrompt}
`
```

ç”Ÿæˆçš„æç¤ºè¯æ ¼å¼ï¼š

```
## å¯ç”¨å·¥å…·

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æ¥å®Œæˆç”¨æˆ·çš„è¯·æ±‚ã€‚è¦è°ƒç”¨å·¥å…·ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

\`\`\`tool
{
  "tool": "å·¥å…·åç§°",
  "args": {
    "å‚æ•°å": "å‚æ•°å€¼"
  }
}
\`\`\`

### search_local_emoji
æœç´¢æœ¬åœ°å·²ä¸‹è½½çš„è¡¨æƒ…åŒ…
åˆ†ç±»: emoji
å‚æ•°:
  - query (string) (å¿…éœ€): æœç´¢å…³é”®è¯
  - limit (number) (å¯é€‰): è¿”å›ç»“æœæ•°é‡
  ç¤ºä¾‹: search_local_emoji("å¼€å¿ƒ"), search_local_emoji("å“­", 5)

### download_emoji_suit
ä¸‹è½½Bç«™è¡¨æƒ…åŒ…è£…æ‰®åˆ°æœ¬åœ°
åˆ†ç±»: emoji
å‚æ•°:
  - suitId (number) (å¿…éœ€): è£…æ‰®IDï¼ˆä»search_bilibili_emojiè·å–ï¼‰
  - suitType (string) (å¿…éœ€): è£…æ‰®ç±»å‹ï¼šnormal æˆ– dlc
  - lotteryId (number) (å¯é€‰): æŠ½å¥–IDï¼ˆdlcç±»å‹éœ€è¦ï¼‰
  ç¤ºä¾‹: download_emoji_suit(114156001, "normal")

...
```

### 3. LLM è°ƒç”¨å·¥å…·

å½“ç”¨æˆ·è¯·æ±‚éœ€è¦å·¥å…·æ—¶ï¼ŒLLM ä¼šç”Ÿæˆå·¥å…·è°ƒç”¨ï¼š

**ç”¨æˆ·**: å¸®æˆ‘æœç´¢ä¸€ä¸ªå¼€å¿ƒçš„è¡¨æƒ…åŒ…

**LLM å“åº”**:
```
å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ æœç´¢å¼€å¿ƒçš„è¡¨æƒ…åŒ…ã€‚

\`\`\`tool
{
  "tool": "search_local_emoji",
  "args": {
    "query": "å¼€å¿ƒ",
    "limit": 5
  }
}
\`\`\`
```

### 4. è§£æå¹¶æ‰§è¡Œå·¥å…·

```typescript
import { 
  extractToolCallFromResponse,
  executePetToolCall 
} from '@/pluginLoader/init'

// ä» LLM å“åº”ä¸­æå–å·¥å…·è°ƒç”¨
const toolCall = extractToolCallFromResponse(llmResponse)

if (toolCall) {
  // æ‰§è¡Œå·¥å…·
  const result = await executePetToolCall(toolCall.tool, toolCall.args)
  
  if (result.success) {
    console.log('å·¥å…·æ‰§è¡ŒæˆåŠŸ:', result.result)
    
    // å°†ç»“æœæ³¨å…¥å›å¯¹è¯
    const resultText = `
[å·¥å…·æ‰§è¡Œç»“æœ]
å·¥å…·: ${result.toolName}
ç»“æœ: ${JSON.stringify(result.result, null, 2)}
`
    
    // ç»§ç»­å¯¹è¯ï¼Œè®© LLM åŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå›å¤
    // ...
  } else {
    console.error('å·¥å…·æ‰§è¡Œå¤±è´¥:', result.error)
  }
}
```

### 5. LLM ç”Ÿæˆæœ€ç»ˆå›å¤

å°†å·¥å…·ç»“æœæ³¨å…¥å›å¯¹è¯åï¼ŒLLM ç”Ÿæˆæœ€ç»ˆå›å¤ï¼š

```
æˆ‘æ‰¾åˆ°äº† 5 ä¸ªå¼€å¿ƒçš„è¡¨æƒ…åŒ…ï¼š
1. å¼€å¿ƒç¬‘è„¸ (é™æ€å›¾)
2. å¼€å¿ƒè·³èˆ (åŠ¨å›¾)
3. å¼€å¿ƒé¼“æŒ (åŠ¨å›¾)
4. å¼€å¿ƒåº†ç¥ (é™æ€å›¾)
5. å¼€å¿ƒæ¯”å¿ƒ (é™æ€å›¾)

ä½ æƒ³è¦å“ªä¸€ä¸ªå‘¢ï¼Ÿ
```

## å®Œæ•´ç¤ºä¾‹

### æ¡Œå® å¯¹è¯å¤„ç†

```typescript
import {
  getPetToolPrompt,
  extractToolCallFromResponse,
  executePetToolCall
} from '@/pluginLoader/init'

async function handleUserMessage(userMessage: string) {
  // 1. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
  const messages = [
    {
      role: 'system',
      content: `ä½ æ˜¯ä¸€ä¸ªå¯çˆ±çš„æ¡Œå® åŠ©æ‰‹ã€‚\n\n${getPetToolPrompt()}`
    },
    {
      role: 'user',
      content: userMessage
    }
  ]
  
  // 2. è°ƒç”¨ LLM
  const llmResponse = await callLLM(messages)
  
  // 3. æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
  const toolCall = extractToolCallFromResponse(llmResponse)
  
  if (toolCall) {
    // 4. æ‰§è¡Œå·¥å…·
    const toolResult = await executePetToolCall(toolCall.tool, toolCall.args)
    
    // 5. å°†ç»“æœæ³¨å…¥å›å¯¹è¯
    messages.push({
      role: 'assistant',
      content: llmResponse
    })
    
    messages.push({
      role: 'system',
      content: `[å·¥å…·æ‰§è¡Œç»“æœ]\nå·¥å…·: ${toolResult.toolName}\nç»“æœ: ${JSON.stringify(toolResult.result)}`
    })
    
    // 6. è®© LLM åŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå›å¤
    const finalResponse = await callLLM(messages)
    
    return finalResponse
  }
  
  // æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œç›´æ¥è¿”å›
  return llmResponse
}
```

## API å‚è€ƒ

### getPetToolPrompt()

è·å–å·¥å…·æç¤ºè¯ï¼Œç”¨äºæ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºä¸­ã€‚

```typescript
const toolPrompt = getPetToolPrompt()
```

### extractToolCallFromResponse(response: string)

ä» LLM å“åº”ä¸­æå–å·¥å…·è°ƒç”¨ã€‚

```typescript
const toolCall = extractToolCallFromResponse(llmResponse)
// è¿”å›: { tool: 'search_local_emoji', args: { query: 'å¼€å¿ƒ', limit: 5 } }
// æˆ– nullï¼ˆå¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼‰
```

### executePetToolCall(toolName: string, args: Record<string, any>)

æ‰§è¡Œå·¥å…·è°ƒç”¨ã€‚

```typescript
const result = await executePetToolCall('search_local_emoji', {
  query: 'å¼€å¿ƒ',
  limit: 5
})

// è¿”å›:
// {
//   success: true,
//   result: { count: 5, emojis: [...] },
//   toolName: 'search_local_emoji'
// }
```

### getPetToolList()

è·å–ç®€åŒ–çš„å·¥å…·åˆ—è¡¨ï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰ã€‚

```typescript
const tools = getPetToolList()
// è¿”å›:
// [
//   {
//     name: 'search_local_emoji',
//     description: 'æœç´¢æœ¬åœ°å·²ä¸‹è½½çš„è¡¨æƒ…åŒ…',
//     category: 'emoji',
//     plugin: 'bilibili-emoji',
//     paramCount: 2
//   },
//   ...
// ]
```

### getPetToolDocumentation()

è·å– Markdown æ ¼å¼çš„å·¥å…·æ–‡æ¡£ã€‚

```typescript
const doc = getPetToolDocumentation()
// è¿”å›å®Œæ•´çš„ Markdown æ–‡æ¡£
```

## å·¥å…·è°ƒç”¨æ ¼å¼

LLM å¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ ¼å¼è°ƒç”¨å·¥å…·ï¼š

```
\`\`\`tool
{
  "tool": "å·¥å…·åç§°",
  "args": {
    "å‚æ•°å": "å‚æ•°å€¼"
  }
}
\`\`\`
```

**ç¤ºä¾‹**:

```
\`\`\`tool
{
  "tool": "search_local_emoji",
  "args": {
    "query": "å¼€å¿ƒ",
    "limit": 5
  }
}
\`\`\`
```

## æœ€ä½³å®è·µ

### 1. æç¤ºè¯è®¾è®¡

åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­æ˜ç¡®è¯´æ˜å·¥å…·ä½¿ç”¨è§„åˆ™ï¼š

```
## å·¥å…·ä½¿ç”¨è§„åˆ™

1. å½“ç”¨æˆ·çš„è¯·æ±‚éœ€è¦ä½¿ç”¨å·¥å…·æ—¶ï¼Œå…ˆè¾“å‡ºä½ çš„æ€è€ƒè¿‡ç¨‹
2. ç„¶åä½¿ç”¨ \`\`\`tool ä»£ç å—è°ƒç”¨å·¥å…·
3. ç­‰å¾…å·¥å…·æ‰§è¡Œç»“æœåï¼Œå†ç»™å‡ºæœ€ç»ˆå›å¤
4. ä¸€æ¬¡åªèƒ½è°ƒç”¨ä¸€ä¸ªå·¥å…·
5. å¦‚æœéœ€è¦å¤šä¸ªå·¥å…·ï¼Œè¯·åˆ†æ­¥éª¤è°ƒç”¨
```

### 2. é”™è¯¯å¤„ç†

```typescript
const result = await executePetToolCall(toolCall.tool, toolCall.args)

if (!result.success) {
  // å‘Šè¯‰ LLM å·¥å…·æ‰§è¡Œå¤±è´¥
  const errorMessage = `å·¥å…·æ‰§è¡Œå¤±è´¥: ${result.error}`
  // ç»§ç»­å¯¹è¯...
}
```

### 3. å·¥å…·é“¾

å¯¹äºéœ€è¦å¤šä¸ªå·¥å…·çš„å¤æ‚ä»»åŠ¡ï¼Œè®© LLM åˆ†æ­¥éª¤è°ƒç”¨ï¼š

```
ç”¨æˆ·: å¸®æˆ‘ä¸‹è½½é¸½å®è¡¨æƒ…åŒ…

LLM: å¥½çš„ï¼Œæˆ‘å…ˆæœç´¢é¸½å®è¡¨æƒ…åŒ…ã€‚

\`\`\`tool
{
  "tool": "search_bilibili_emoji",
  "args": { "keyword": "é¸½å®" }
}
\`\`\`

[å·¥å…·ç»“æœ: æ‰¾åˆ°è£…æ‰® ID 114156001]

LLM: æ‰¾åˆ°äº†é¸½å®è£…æ‰®ï¼Œç°åœ¨å¼€å§‹ä¸‹è½½ã€‚

\`\`\`tool
{
  "tool": "download_emoji_suit",
  "args": { "suitId": 114156001, "suitType": "normal" }
}
\`\`\`

[å·¥å…·ç»“æœ: æˆåŠŸä¸‹è½½ 24 ä¸ªè¡¨æƒ…åŒ…]

LLM: å·²æˆåŠŸä¸‹è½½é¸½å®è¡¨æƒ…åŒ…ï¼Œå…± 24 ä¸ªè¡¨æƒ…ï¼
```

## è°ƒè¯•

### æŸ¥çœ‹å¯ç”¨å·¥å…·

```typescript
const tools = getPetToolList()
console.log('å¯ç”¨å·¥å…·:', tools)
```

### æŸ¥çœ‹å·¥å…·ç»Ÿè®¡

```typescript
const stats = (window as any).__petToolManager.getToolStats()
console.log('å·¥å…·ç»Ÿè®¡:', stats)
```

### æµ‹è¯•å·¥å…·è°ƒç”¨

```typescript
const result = await executePetToolCall('search_local_emoji', {
  query: 'å¼€å¿ƒ',
  limit: 5
})
console.log('æµ‹è¯•ç»“æœ:', result)
```

## æ€»ç»“

æ¡Œå® å·¥å…·ç³»ç»Ÿæä¾›äº†ï¼š

âœ… è‡ªåŠ¨æ‰«ææ’ä»¶æ³¨å†Œçš„å·¥å…·
âœ… ç”Ÿæˆå·¥å…·æç¤ºè¯æ³¨å…¥åˆ°ç³»ç»Ÿæç¤º
âœ… è§£æ LLM çš„å·¥å…·è°ƒç”¨è¯·æ±‚
âœ… æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ
âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
âœ… å·¥å…·æ–‡æ¡£ç”Ÿæˆ

è®©æ¡Œå®  LLM èƒ½å¤ŸçœŸæ­£ä½¿ç”¨æ’ä»¶æä¾›çš„èƒ½åŠ›ï¼ğŸ‰
