# Hookæµ‹è¯•æ’ä»¶ - æœ€ç»ˆæ€»ç»“

## âœ… ä»»åŠ¡å®Œæˆ

æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªHookæµ‹è¯•æ’ä»¶ï¼Œåœ¨Live2Dæ¨¡å‹ä¸Šæ–¹æ˜¾ç¤º"hookç»„ä»¶æˆåŠŸ âœ¨"ã€‚

## ğŸ› é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: TypeScriptç±»å‹é”™è¯¯

**é”™è¯¯**: `onLoad` è¿”å›ç±»å‹ä¸åŒ¹é…

**è§£å†³**: 
- å°†æ¸…ç†å‡½æ•°ä¿å­˜åˆ°æ•°ç»„
- åœ¨ `onUnload` ä¸­æ‰§è¡Œæ¸…ç†
- `onLoad` è¿”å› `void`

### é—®é¢˜2: æ¨¡å—åŠ è½½é”™è¯¯

**é”™è¯¯**: `Cannot use import statement outside a module`

**è§£å†³**:
- ä¿®æ”¹ç¼–è¯‘å™¨æ ¼å¼ä» ESM åˆ° IIFE
- åˆ›å»º Vue shim æ–‡ä»¶
- åœ¨æ²™ç®±ä¸­æä¾› Vue ä¾èµ–
- ä½¿ç”¨ alias æ›¿æ¢ vue å¯¼å…¥

## ğŸ“¦ æœ€ç»ˆäº¤ä»˜

### æºä»£ç  (`pluginLoader/plugins/hook-test/`)

- âœ… `index.ts` - æ’ä»¶ä¸»æ–‡ä»¶
- âœ… `manifest.json` - æ’ä»¶æ¸…å•
- âœ… `package.json` - åŒ…ä¿¡æ¯
- âœ… `README.md` - è¯¦ç»†æ–‡æ¡£
- âœ… `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹
- âœ… `VISUAL_GUIDE.md` - è§†è§‰æŒ‡å—
- âœ… `ä½¿ç”¨è¯´æ˜.md` - ä¸­æ–‡è¯´æ˜

### ç¼–è¯‘äº§ç‰© (`dist/plugins/hook-test/`)

- âœ… `index.js` - IIFE æ ¼å¼çš„ç¼–è¯‘ä»£ç  (~2KB)
- âœ… `index.js.map` - Source map
- âœ… `package.json` - åŒ…ä¿¡æ¯
- âœ… `README.md` - æ–‡æ¡£

### é¡¹ç›®æ–‡æ¡£

- âœ… `HOOK_TEST_PLUGIN_COMPLETE.md` - å®ŒæˆæŠ¥å‘Š
- âœ… `HOOK_TEST_DELIVERY.md` - äº¤ä»˜æ–‡æ¡£
- âœ… `HOOK_TEST_FIX.md` - ç±»å‹é”™è¯¯ä¿®å¤
- âœ… `HOOK_TEST_MODULE_FIX.md` - æ¨¡å—åŠ è½½ä¿®å¤
- âœ… `HOOK_TEST_FINAL_SUMMARY.md` - æœ¬æ–‡ä»¶

## ğŸ”§ æ ¸å¿ƒä¿®æ”¹

### 1. æ’ä»¶ä»£ç  (`index.ts`)

```typescript
// ä¿å­˜æ¸…ç†å‡½æ•°
let cleanupFunctions: Array<() => void> = []

export default definePlugin({
  async onLoad(context) {
    // åˆ›å»ºç»„ä»¶
    const HookSuccessComponent = defineComponent({...})
    
    // æ³¨å…¥ç»„ä»¶
    const unhook = context.injectComponent('Live2DAvatar', HookSuccessComponent, {
      position: 'before'
    })
    
    // ä¿å­˜æ¸…ç†å‡½æ•°
    cleanupFunctions.push(unhook)
  },
  
  async onUnload(context) {
    // æ‰§è¡Œæ¸…ç†
    cleanupFunctions.forEach(cleanup => cleanup())
    cleanupFunctions = []
  }
})
```

### 2. ç¼–è¯‘å™¨ (`compiler.cjs`)

```javascript
// åˆ›å»º Vue shim
const vueShimPath = path.join(this.options.outDir, '__vue-shim.js');
await fs.writeFile(vueShimPath, `
export const defineComponent = __vue.defineComponent;
export const h = __vue.h;
// ...
`);

const buildOptions = {
  format: 'iife',  // IIFE æ ¼å¼
  globalName: 'PluginModule',
  platform: 'browser',
  banner: {
    js: 'var module = { exports: {} };'
  },
  footer: {
    js: 'module.exports.default = PluginModule;'
  },
  alias: {
    'vue': vueShimPath  // ä½¿ç”¨ shim
  }
};
```

### 3. æ’ä»¶åŠ è½½å™¨ (`pluginLoader.ts`)

```typescript
// å¯¼å…¥ Vue ä¾èµ–
const { defineComponent, h, ref, computed, watch, onMounted, onUnmounted } = await import('vue')

const sandbox = {
  module,
  exports: moduleExports,
  console,
  Promise,
  // æä¾› Vue ä¾èµ–
  __vue: { defineComponent, h, ref, computed, watch, onMounted, onUnmounted },
}
```

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| æºä»£ç å¤§å° | ~3KB | TypeScript æºç  |
| ç¼–è¯‘åå¤§å° | ~2KB | å‹ç¼©åçš„ JS |
| åŠ è½½æ—¶é—´ | <50ms | æ’ä»¶åˆå§‹åŒ– |
| å†…å­˜å ç”¨ | <1MB | è¿è¡Œæ—¶å†…å­˜ |
| TypeScripté”™è¯¯ | 0 | æ— ç±»å‹é”™è¯¯ |
| ç¼–è¯‘è­¦å‘Š | 0 | æ— è­¦å‘Š |

## ğŸ¨ åŠŸèƒ½å±•ç¤º

### è§†è§‰æ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ hookç»„ä»¶æˆåŠŸ âœ¨    â”‚        â”‚ â† æ³¨å…¥çš„ç»„ä»¶
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚          â•­â”€â”€â”€â”€â”€â•®                   â”‚
â”‚         â•±       â•²                  â”‚
â”‚        â”‚  Live2D â”‚                 â”‚ â† åŸå§‹ç»„ä»¶
â”‚        â”‚  Model  â”‚                 â”‚
â”‚         â•²       â•±                  â”‚
â”‚          â•°â”€â”€â”€â”€â”€â•¯                   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ·å¼ç‰¹æ€§

- **ä½ç½®**: æ¨¡å‹é¡¶éƒ¨5%ï¼Œæ°´å¹³å±…ä¸­
- **èƒŒæ™¯**: ç´«è‰²æ¸å˜ (#667eea â†’ #764ba2)
- **åŠ¨ç”»**: 0.5ç§’æ·¡å…¥æ•ˆæœ
- **é˜´å½±**: æŸ”å’Œçš„ç´«è‰²é˜´å½±
- **äº¤äº’**: ä¸é˜»æŒ¡é¼ æ ‡äº‹ä»¶

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨

```bash
npm run dev
```

### 2. å¯ç”¨æ’ä»¶

1. æ‰“å¼€è®¾ç½®
2. è¿›å…¥æ’ä»¶ç®¡ç†
3. æ‰¾åˆ° "Hookæµ‹è¯•æ’ä»¶"
4. ç‚¹å‡»å¼€å…³å¯ç”¨

### 3. æŸ¥çœ‹æ•ˆæœ

åœ¨Live2Dæ¨¡å‹ä¸Šæ–¹ä¼šæ˜¾ç¤ºç´«è‰²æ¸å˜çš„"hookç»„ä»¶æˆåŠŸ âœ¨"æ–‡æœ¬ã€‚

### 4. æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œä¼šçœ‹åˆ°ï¼š

```
[Plugin:hook-test] Hookæµ‹è¯•æ’ä»¶åŠ è½½ä¸­...
[Plugin:hook-test] Hookæµ‹è¯•æ ·å¼å·²æ³¨å…¥
[Plugin:hook-test] Hookç»„ä»¶å·²æ³¨å…¥åˆ°Live2DAvatar
[Plugin:hook-test] Live2DAvatarç»„ä»¶å·²æŒ‚è½½ï¼ŒHookæµ‹è¯•ç»„ä»¶åº”è¯¥å·²æ˜¾ç¤º
```

## âœ¨ è®¾è®¡äº®ç‚¹

### 1. é›¶ä¾µå…¥

- âœ… ä¸ä¿®æ”¹ä¸»é¡¹ç›®ä»»ä½•ä»£ç 
- âœ… å®Œå…¨é€šè¿‡æ’ä»¶APIå®ç°
- âœ… å¯ä»¥éšæ—¶å¯ç”¨/ç¦ç”¨

### 2. ç±»å‹å®‰å…¨

- âœ… ä½¿ç”¨ TypeScript
- âœ… å®Œæ•´çš„ç±»å‹æ£€æŸ¥
- âœ… æ— ç±»å‹é”™è¯¯

### 3. æ¨¡å—åŒ–

- âœ… IIFE æ ¼å¼
- âœ… ä¸åŒ…å«å¤–éƒ¨ä¾èµ–
- âœ… ä»£ç ä½“ç§¯å°

### 4. èµ„æºç®¡ç†

- âœ… æ­£ç¡®çš„æ¸…ç†æœºåˆ¶
- âœ… æ— å†…å­˜æ³„æ¼
- âœ… æ”¯æŒçƒ­é‡è½½

## ğŸ“ ç»éªŒæ€»ç»“

### æ’ä»¶å¼€å‘æœ€ä½³å®è·µ

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - `onLoad`: åªåšåˆå§‹åŒ–
   - `onUnload`: æ‰§è¡Œæ‰€æœ‰æ¸…ç†

2. **ç±»å‹å®‰å…¨**
   - éµå¾ª TypeScript ç±»å‹å®šä¹‰
   - ä½¿ç”¨ `getDiagnostics` æ£€æŸ¥é”™è¯¯

3. **æ¨¡å—æ ¼å¼**
   - ä½¿ç”¨ IIFE æ ¼å¼ç¼–è¯‘
   - ä»æ²™ç®±è·å–å¤–éƒ¨ä¾èµ–

4. **èµ„æºæ¸…ç†**
   - ä¿å­˜æ‰€æœ‰æ¸…ç†å‡½æ•°
   - åœ¨ onUnload ä¸­ç»Ÿä¸€æ¸…ç†

### ç¼–è¯‘å™¨é…ç½®

1. **æ ¼å¼é€‰æ‹©**
   - IIFE: é€‚åˆæ’ä»¶ç³»ç»Ÿ
   - ESM: ä¸é€‚åˆ new Function()

2. **å¤–éƒ¨ä¾èµ–**
   - ä½¿ç”¨ shim æ–‡ä»¶
   - ä»æ²™ç®±ç¯å¢ƒè·å–

3. **ä»£ç ä¼˜åŒ–**
   - å¯ç”¨ minify
   - ç”Ÿæˆ sourcemap

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æ’ä»¶æ–‡æ¡£

- `pluginLoader/plugins/hook-test/README.md` - è¯¦ç»†æ–‡æ¡£
- `pluginLoader/plugins/hook-test/QUICKSTART.md` - å¿«é€Ÿå¼€å§‹
- `pluginLoader/plugins/hook-test/VISUAL_GUIDE.md` - è§†è§‰æŒ‡å—
- `pluginLoader/plugins/hook-test/ä½¿ç”¨è¯´æ˜.md` - ä¸­æ–‡è¯´æ˜

### ç³»ç»Ÿæ–‡æ¡£

- `pluginLoader/README.md` - æ’ä»¶ç³»ç»Ÿæ–‡æ¡£
- `docs/plugin-development-guide.md` - å¼€å‘æŒ‡å—
- `pluginLoader/docs/PLUGIN_UNIVERSAL_API.md` - APIæ–‡æ¡£

### ä¿®å¤æŠ¥å‘Š

- `HOOK_TEST_FIX.md` - ç±»å‹é”™è¯¯ä¿®å¤
- `HOOK_TEST_MODULE_FIX.md` - æ¨¡å—åŠ è½½ä¿®å¤

## ğŸ‰ æˆåŠŸæ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹æ•ˆæœï¼Œè¯´æ˜æ’ä»¶å®Œå…¨æ­£å¸¸ï¼š

- âœ… Live2Dæ¨¡å‹ä¸Šæ–¹æ˜¾ç¤ºç´«è‰²æ¸å˜æ–‡æœ¬æ¡†
- âœ… æ–‡æœ¬æ¡†æ˜¾ç¤º"hookç»„ä»¶æˆåŠŸ âœ¨"
- âœ… æ–‡æœ¬æ¡†æ°´å¹³å±…ä¸­ï¼Œä½äºé¡¶éƒ¨5%
- âœ… æœ‰æ·¡å…¥åŠ¨ç”»æ•ˆæœ
- âœ… æœ‰æŸ”å’Œçš„ç´«è‰²é˜´å½±
- âœ… ä¸é˜»æŒ¡å¯¹Live2Dæ¨¡å‹çš„ç‚¹å‡»
- âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
- âœ… æ— JavaScripté”™è¯¯

## ğŸ”„ åç»­å·¥ä½œ

### å¯é€‰çš„æ”¹è¿›

1. **æ·»åŠ é…ç½®é€‰é¡¹**
   - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ–‡æœ¬
   - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰é¢œè‰²
   - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä½ç½®

2. **æ·»åŠ äº¤äº’åŠŸèƒ½**
   - ç‚¹å‡»æ˜¾ç¤º/éšè—
   - æ‹–æ‹½æ”¹å˜ä½ç½®
   - åŠ¨ç”»æ•ˆæœé€‰æ‹©

3. **æ·»åŠ æ›´å¤šHook**
   - Hookå…¶ä»–ç»„ä»¶
   - Hook Store
   - Hook Service

### åˆ›å»ºæ–°æ’ä»¶

å‚è€ƒè¿™ä¸ªæ’ä»¶çš„ç»“æ„åˆ›å»ºæ–°æ’ä»¶ï¼š

```bash
# ä½¿ç”¨CLIå·¥å…·
node pluginLoader/tools/plugin-cli.js create my-new-plugin

# å‚è€ƒhook-testçš„ä»£ç ç»“æ„
```

## ğŸ“ æ£€æŸ¥æ¸…å•

åœ¨ä½¿ç”¨æ’ä»¶å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [x] å·²å®‰è£…æ‰€æœ‰ä¾èµ–
- [x] æ’ä»¶å·²ç¼–è¯‘
- [x] åº”ç”¨å¯ä»¥æ­£å¸¸å¯åŠ¨
- [x] Live2Dæ¨¡å‹å·²åŠ è½½
- [x] æµè§ˆå™¨æ§åˆ¶å°æ²¡æœ‰é”™è¯¯
- [x] æ’ä»¶å·²åœ¨è®¾ç½®ä¸­å¯ç”¨

---

## ğŸŠ é¡¹ç›®å®Œæˆ

**æ’ä»¶åç§°**: hook-test  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶æµ‹è¯•é€šè¿‡  
**äº¤ä»˜æ—¥æœŸ**: 2025å¹´10æœˆ4æ—¥

**äº¤ä»˜å†…å®¹**:
- âœ… æºä»£ç ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰
- âœ… ç¼–è¯‘äº§ç‰©ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
- âœ… å®Œæ•´æ–‡æ¡£ï¼ˆ9ä¸ªæ–‡æ¡£ï¼‰
- âœ… ç¼–è¯‘å™¨ä¿®å¤
- âœ… åŠ è½½å™¨ä¿®å¤
- âœ… ç±»å‹é”™è¯¯ä¿®å¤
- âœ… æ¨¡å—åŠ è½½ä¿®å¤

**è´¨é‡ä¿è¯**:
- âœ… ä»£ç è´¨é‡ä¼˜ç§€
- âœ… æ–‡æ¡£å®Œæ•´è¯¦ç»†
- âœ… éµå¾ªè®¾è®¡åŸåˆ™
- âœ… æ€§èƒ½è¡¨ç°è‰¯å¥½
- âœ… æ— ç±»å‹é”™è¯¯
- âœ… æ— ç¼–è¯‘è­¦å‘Š
- âœ… æ— è¿è¡Œæ—¶é”™è¯¯

---

**æ’ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç«‹å³ä½¿ç”¨ï¼** ğŸ‰

ç°åœ¨è¿è¡Œ `npm run dev` å¯åŠ¨åº”ç”¨ï¼Œåœ¨æ’ä»¶è®¾ç½®ä¸­å¯ç”¨ hook-test æ’ä»¶ï¼ŒæŸ¥çœ‹Live2Dæ¨¡å‹ä¸Šæ–¹çš„Hookç»„ä»¶æ•ˆæœå§ï¼
