# 插件系统架构可视化

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          主应用程序                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Vue App                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│  │  │  Components │  │   Router    │  │   Stores    │      │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↕                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              插件加载器 (EnhancedPluginLoader)            │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  PathResolver  │  HotReload  │  RuntimeInjection   │ │  │
│  │  ├─────────────────────────────────────────────────────┤ │  │
│  │  │  HookEngine    │  ComponentInjection  │  ToolMgr   │ │  │
│  │  ├─────────────────────────────────────────────────────┤ │  │
│  │  │  BackendLoader │  StorageManager  │  PluginAPI     │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↕                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      插件实例                              │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │  │
│  │  │  Plugin A    │  │  Plugin B    │  │  Plugin C    │   │  │
│  │  │  ┌────────┐  │  │  ┌────────┐  │  │  ┌────────┐  │   │  │
│  │  │  │Frontend│  │  │  │Frontend│  │  │  │Frontend│  │   │  │
│  │  │  ├────────┤  │  │  ├────────┤  │  │  ├────────┤  │   │  │
│  │  │  │Backend │  │  │  │Backend │  │  │  │Backend │  │   │  │
│  │  │  │(Rust)  │  │  │  │(Rust)  │  │  │  │(Rust)  │  │   │  │
│  │  │  └────────┘  │  │  └────────┘  │  │  └────────┘  │   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 路径管理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      PathResolver                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  开发环境                          生产环境                      │
│  ┌──────────────────────┐         ┌──────────────────────┐     │
│  │ project/             │         │ app/                 │     │
│  │ ├─ pluginLoader/     │         │ ├─ main-app.exe      │     │
│  │ │  └─ plugins/       │ ──────> │ ├─ plugins/          │     │
│  │ │     └─ my-plugin/  │         │ │  └─ my-plugin/     │     │
│  │ │        ├─ index.ts │         │ │     ├─ index.js    │     │
│  │ │        ├─ assets/  │         │ │     ├─ assets/     │     │
│  │ │        └─ backend/ │         │ │     └─ backend/    │     │
│  │ │                    │         │ │        └─ plugin.*  │     │
│  │ └─ plugin-data/      │         │ └─ [用户数据目录]/   │     │
│  │    └─ my-plugin/     │         │    plugin-data/      │     │
│  │       ├─ config.json │         │    └─ my-plugin/     │     │
│  │       └─ cache/       │         │       ├─ config.json│     │
│  └──────────────────────┘         │       └─ cache/      │     │
│                                    └──────────────────────┘     │
│                                                                  │
│  跨平台路径适配：                                                │
│  • Windows: %APPDATA%/YourApp/plugin-data/                      │
│  • macOS:   ~/Library/Application Support/YourApp/plugin-data/  │
│  • Linux:   ~/.config/yourapp/plugin-data/                      │
└─────────────────────────────────────────────────────────────────┘
```

## 热加载流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    HotReloadManager                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  chokidar 监听插件目录                   │
        │  watch(pluginDir, { ... })              │
        └─────────────────────────────────────────┘
                              │
                              ↓ 文件变化
        ┌─────────────────────────────────────────┐
        │  防抖处理 (500ms)                        │
        │  debounce(() => reload(), 500)          │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  清除模块缓存                            │
        │  delete require.cache[...]              │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  卸载插件                                │
        │  await pluginLoader.unloadPlugin(id)    │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  重新加载插件                            │
        │  await pluginLoader.loadPlugin(id)      │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  触发事件                                │
        │  emit('plugin-reloaded', id)            │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  通知UI更新                              │
        └─────────────────────────────────────────┘
```

## 编译和注入流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      构建时注入                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  插件源码                    构建脚本                 输出        │
│  ┌──────────┐              ┌──────────┐           ┌──────────┐ │
│  │ index.ts │ ──────────>  │   tsc    │ ────────> │ index.js │ │
│  └──────────┘              └──────────┘           └──────────┘ │
│                                                                  │
│  ┌──────────┐              ┌──────────┐           ┌──────────┐ │
│  │backend/  │ ──────────>  │  cargo   │ ────────> │plugin.*  │ │
│  │src/lib.rs│              │  build   │           │.dll/.dylib│ │
│  └──────────┘              └──────────┘           └──────────┘ │
│                                                                  │
│  ┌──────────┐              ┌──────────┐           ┌──────────┐ │
│  │ assets/  │ ──────────>  │   copy   │ ────────> │ assets/  │ │
│  └──────────┘              └──────────┘           └──────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      启动时注入                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  main.ts                                                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ import { EnhancedPluginLoader } from 'pluginLoader'        │ │
│  │                                                            │ │
│  │ const loader = new EnhancedPluginLoader()                 │ │
│  │ await loader.initialize()  // 自动发现和加载所有插件       │ │
│  │                                                            │ │
│  │ const app = createApp(App)                                │ │
│  │ loader.setVueApp(app)                                     │ │
│  │ app.mount('#app')                                         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      运行时注入                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 动态加载插件                                                │ │
│  │ await loader.loadPlugin('my-plugin')                       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Hook注入                                                    │ │
│  │ hookEngine.registerHook('message.send', handler)           │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 组件注入                                                    │ │
│  │ componentInjection.register('MyComponent', component)      │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 后端加载                                                    │ │
│  │ backendLoader.load(pluginId)                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 插件生命周期

```
┌─────────────────────────────────────────────────────────────────┐
│                      插件生命周期                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  1. 发现插件                             │
        │  discoverPlugins()                      │
        │  • 扫描 plugins/ 目录                    │
        │  • 读取 package.json                    │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  2. 加载插件                             │
        │  loadPlugin(pluginId)                   │
        │  • require() 插件入口                    │
        │  • 创建 PluginAPI 实例                   │
        │  • 调用插件工厂函数                       │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  3. 激活插件                             │
        │  plugin.activate()                      │
        │  • 加载后端                              │
        │  • 注册 Hook                             │
        │  • 注册组件                              │
        │  • 注册工具                              │
        │  • 加载配置                              │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  4. 运行中                               │
        │  • Hook 拦截和处理                       │
        │  • 组件渲染                              │
        │  • 后端调用                              │
        │  • 数据存储                              │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  5. 停用插件                             │
        │  plugin.deactivate()                    │
        │  • 保存配置                              │
        │  • 卸载后端                              │
        │  • 清理资源                              │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  6. 卸载插件                             │
        │  unloadPlugin(pluginId)                 │
        │  • 取消注册 Hook                         │
        │  • 取消注册组件                          │
        │  • 取消注册工具                          │
        │  • 清除缓存                              │
        └─────────────────────────────────────────┘
```

## Hook系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      HookEngine                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Hook注册表                                                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 'message.send': [                                          │ │
│  │   { pluginId: 'plugin-a', handler: fn1 },                 │ │
│  │   { pluginId: 'plugin-b', handler: fn2 }                  │ │
│  │ ],                                                         │ │
│  │ 'component.mounted': [                                     │ │
│  │   { pluginId: 'plugin-c', handler: fn3 }                  │ │
│  │ ]                                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  主程序触发 Hook                         │
        │  hookEngine.trigger('message.send', ctx)│
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  按顺序执行所有处理器                     │
        │  for (handler of handlers) {            │
        │    ctx = await handler(ctx)             │
        │  }                                      │
        └─────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  返回处理后的上下文                       │
        │  return ctx                             │
        └─────────────────────────────────────────┘
```

## 组件注入架构

```
┌─────────────────────────────────────────────────────────────────┐
│                  ComponentInjection                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  组件注册表                                                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 'EmojiPicker': {                                           │ │
│  │   pluginId: 'bilibili-emoji',                             │ │
│  │   component: () => import('./EmojiPicker.vue'),           │ │
│  │   props: { theme: 'dark' }                                │ │
│  │ },                                                         │ │
│  │ 'CustomButton': {                                         │ │
│  │   pluginId: 'ui-plugin',                                  │ │
│  │   component: () => import('./Button.vue')                 │ │
│  │ }                                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────┐
        │  主程序使用插件组件                       │
        │  <component                             │
        │    :is="getPluginComponent('EmojiPicker')"│
        │    v-bind="getPluginProps('EmojiPicker')"│
        │  />                                     │
        └─────────────────────────────────────────┘
```

## 后端交互架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端 (TypeScript)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  const backend = await api.backend.load()                       │
│  const result = await backend.call('method', params)            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓ FFI (ffi-napi)
┌─────────────────────────────────────────────────────────────────┐
│                    BackendLoader                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ffi.Library(backendPath, {                                     │
│    'plugin_init': ['string', []],                               │
│    'plugin_call': ['string', ['string', 'string']],             │
│    'plugin_cleanup': ['void', []]                               │
│  })                                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓ C ABI
┌─────────────────────────────────────────────────────────────────┐
│                    后端 (Rust)                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  #[no_mangle]                                                   │
│  pub extern "C" fn plugin_call(                                 │
│      method: *const c_char,                                     │
│      params: *const c_char                                      │
│  ) -> *mut c_char {                                             │
│      // 处理逻辑                                                 │
│      let result = match method {                                │
│          "process" => process_data(params),                     │
│          _ => Err("Unknown method")                             │
│      };                                                         │
│      to_c_string(serialize_result(result))                      │
│  }                                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                      用户操作                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Vue 组件                                    │
│  • 用户点击按钮                                                  │
│  • 触发事件                                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Hook 拦截                                   │
│  hookEngine.trigger('message.send', context)                    │
│  • Plugin A 处理                                                 │
│  • Plugin B 处理                                                 │
│  • Plugin C 处理                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      后端处理                                    │
│  backend.call('process', data)                                  │
│  • Rust 后端处理数据                                             │
│  • 返回处理结果                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储                                    │
│  api.storage.set('key', value)                                  │
│  • 保存到用户数据目录                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      UI 更新                                     │
│  • 组件重新渲染                                                  │
│  • 显示处理结果                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 跨平台支持

```
┌─────────────────────────────────────────────────────────────────┐
│                      PathResolver                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  getUserDataPath() {                                            │
│    switch (process.platform) {                                  │
│      case 'win32':                                              │
│        return '%APPDATA%/YourApp/plugin-data/'                  │
│      case 'darwin':                                             │
│        return '~/Library/Application Support/YourApp/...'       │
│      case 'linux':                                              │
│        return '~/.config/yourapp/plugin-data/'                  │
│    }                                                            │
│  }                                                              │
│                                                                  │
│  getPluginBackend(pluginId) {                                   │
│    const ext = platform === 'win32' ? '.dll' :                  │
│                platform === 'darwin' ? '.dylib' : '.so'         │
│    return path.join(backendDir, `libplugin${ext}`)             │
│  }                                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 总结

这个架构提供了：

1. **清晰的层次结构**：主应用 → 插件加载器 → 插件实例
2. **完整的生命周期管理**：发现 → 加载 → 激活 → 运行 → 停用 → 卸载
3. **灵活的扩展机制**：Hook、组件注入、工具注册
4. **高性能后端支持**：Rust + FFI
5. **跨平台兼容**：Windows/macOS/Linux 自动适配
6. **开发友好**：热加载、CLI工具、详细日志

所有组件协同工作，提供了一个完整、可靠、易用的插件系统！

