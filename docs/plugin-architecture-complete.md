# æ’ä»¶ç³»ç»Ÿå®Œæ•´æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯æ’ä»¶ç³»ç»Ÿçš„å®Œæ•´æ¶æ„è®¾è®¡ï¼Œæ•´åˆäº†ç³»ç»Ÿè®¾è®¡ã€è¿è¡Œæ—¶æœºåˆ¶ã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­‰æ‰€æœ‰æ ¸å¿ƒå†…å®¹ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **æ— ä¾µå…¥å¼æ‰©å±•** - é›¶æºç ä¿®æ”¹å®ç°åŠŸèƒ½æ‰©å±•
- **çƒ­æ’æ‹”æ”¯æŒ** - è¿è¡Œæ—¶åŠ è½½/å¸è½½ï¼Œæ— éœ€é‡å¯åº”ç”¨
- **å‰åç«¯åˆ†ç¦»** - æ”¯æŒçº¯å‰ç«¯æ’ä»¶å’Œå¸¦Ruståç«¯çš„æ··åˆæ’ä»¶
- **è·¨å¹³å°æ”¯æŒ** - Windows/macOS/Linux ç»Ÿä¸€æ¶æ„
- **å®‰å…¨æ²™ç®±** - æƒé™æ§åˆ¶å’Œä»£ç éš”ç¦»

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸»åº”ç”¨ (Vue + Tauri)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              æ’ä»¶åŠ è½½å™¨ (PluginLoader)                â”‚  â”‚
â”‚  â”‚  - æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†                                   â”‚  â”‚
â”‚  â”‚  - æƒé™æ§åˆ¶                                           â”‚  â”‚
â”‚  â”‚  - ä¾èµ–è§£æ                                           â”‚  â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Hookå¼•æ“       â”‚  â”‚  åŒ…ç®¡ç†å™¨     â”‚  â”‚  è¿è¡Œæ—¶ç®¡ç†   â”‚  â”‚
â”‚  â”‚  - ç»„ä»¶Hook     â”‚  â”‚  - å®‰è£…/å¸è½½  â”‚  â”‚  - åç«¯è¿›ç¨‹   â”‚  â”‚
â”‚  â”‚  - Store Hook   â”‚  â”‚  - ç‰ˆæœ¬ç®¡ç†   â”‚  â”‚  - åŠ¨æ€åº“åŠ è½½ â”‚  â”‚
â”‚  â”‚  - æœåŠ¡Hook     â”‚  â”‚  - ä¾èµ–æ£€æŸ¥   â”‚  â”‚  - IPCé€šä¿¡    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ æ’ä»¶A     â”‚      â”‚  æ’ä»¶B       â”‚     â”‚  æ’ä»¶C      â”‚
   â”‚ (çº¯å‰ç«¯)  â”‚      â”‚ (å‰ç«¯+åç«¯)  â”‚     â”‚ (çº¯å‰ç«¯)    â”‚
   â”‚          â”‚      â”‚              â”‚     â”‚            â”‚
   â”‚ index.js â”‚      â”‚ index.js     â”‚     â”‚ index.js   â”‚
   â”‚          â”‚      â”‚ backend.dll  â”‚     â”‚            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. æ’ä»¶åŠ è½½å™¨ (PluginLoader)

**èŒè´£**ï¼š
- æ’ä»¶çš„åŠ è½½ã€å¸è½½ã€çƒ­é‡è½½
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆonLoadã€onUnloadï¼‰
- æƒé™éªŒè¯å’Œä¾èµ–è§£æ
- æ’ä»¶ä¸Šä¸‹æ–‡ï¼ˆPluginContextï¼‰åˆ›å»º

**å…³é”®æ–¹æ³•**ï¼š
```typescript
class PluginLoader {
  // åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿ
  async initialize(app: App, router: Router): Promise<void>
  
  // åŠ è½½å•ä¸ªæ’ä»¶
  async loadPlugin(pluginId: string): Promise<boolean>
  
  // å¸è½½æ’ä»¶
  async unloadPlugin(pluginId: string): Promise<boolean>
  
  // å®Œå…¨ç§»é™¤æ’ä»¶ï¼ˆåˆ é™¤æ–‡ä»¶ï¼‰
  async removePlugin(pluginId: string): Promise<boolean>
  
  // æ‰¹é‡åŠ è½½
  async loadPlugins(pluginIds: string[]): Promise<void>
  
  // è·å–å·²åŠ è½½æ’ä»¶
  getLoadedPlugins(): PluginMetadata[]
}
```

### 2. Hookå¼•æ“ (HookEngine)

**èŒè´£**ï¼š
- æ‹¦æˆªå’Œå¢å¼ºVueç»„ä»¶ã€Pinia Storeã€æœåŠ¡å‡½æ•°
- æä¾›before/after/replaceé’©å­
- ç®¡ç†Hookçš„æ³¨å†Œå’Œæ³¨é”€

**Hookç±»å‹**ï¼š

1. **ç»„ä»¶Hook (ComponentHooks)**
   ```typescript
   interface ComponentHooks {
     beforeMount?: (instance) => void
     mounted?: (instance) => void
     beforeUpdate?: (instance) => void
     updated?: (instance) => void
     beforeUnmount?: (instance) => void
     unmounted?: (instance) => void
   }
   ```

2. **Store Hook (StoreHooks)**
   ```typescript
   interface StoreHooks {
     beforeAction?: (name, args) => void | false
     afterAction?: (name, args, result) => void
     onStateChange?: (state, oldState) => void
   }
   ```

3. **æœåŠ¡Hook (ServiceHooks)**
   ```typescript
   interface ServiceHooks {
     before?: (...args) => any[] | void
     after?: (result, ...args) => any
     replace?: (...args) => any
     onError?: (error, ...args) => void
   }
   ```

### 3. åŒ…ç®¡ç†å™¨ (PackageManager)

**èŒè´£**ï¼š
- æ’ä»¶çš„å®‰è£…ã€å¸è½½ã€æ›´æ–°
- æ’ä»¶æ–‡ä»¶ç®¡ç†ï¼ˆè¯»å–ã€éªŒè¯ï¼‰
- æ’ä»¶å…ƒæ•°æ®ç®¡ç†ï¼ˆmanifest.jsonï¼‰
- åç«¯åŠ¨æ€åº“åŠ è½½

**æ’ä»¶åŒ…ç»“æ„**ï¼š
```
plugin-name.zip
â”œâ”€â”€ manifest.json          # æ’ä»¶å…ƒæ•°æ®
â”œâ”€â”€ index.js              # å‰ç«¯å…¥å£ï¼ˆç¼–è¯‘åï¼‰
â”œâ”€â”€ icon.png              # æ’ä»¶å›¾æ ‡
â”œâ”€â”€ README.md             # è¯´æ˜æ–‡æ¡£
â””â”€â”€ backend/              # åç«¯ï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€ plugin.dll        # WindowsåŠ¨æ€åº“
    â”œâ”€â”€ libplugin.dylib   # macOSåŠ¨æ€åº“
    â””â”€â”€ libplugin.so      # LinuxåŠ¨æ€åº“
```

### 4. è¿è¡Œæ—¶ç®¡ç†å™¨ (PluginRuntime)

**èŒè´£**ï¼š
- ç®¡ç†æ’ä»¶åç«¯è¿›ç¨‹/åŠ¨æ€åº“
- å¤„ç†å‰åç«¯é€šä¿¡ï¼ˆIPCï¼‰
- ç›‘æ§åç«¯çŠ¶æ€

## ğŸ“ è·¯å¾„ç®¡ç†æ¶æ„

### ç›®å½•ç»“æ„è®¾è®¡

```
å¼€å‘ç¯å¢ƒï¼š
project/
â”œâ”€â”€ pluginLoader/plugins/         # æ’ä»¶æºç 
â”‚   â””â”€â”€ bilibili-emoji/
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ assets/              # å†…ç½®èµ„æº
â”‚       â””â”€â”€ backend/src/         # Rustæºç 

ç”Ÿäº§ç¯å¢ƒï¼š
[ç”¨æˆ·æ•°æ®ç›®å½•]/plugins/          # æ’ä»¶å®‰è£…ç›®å½•
â”œâ”€â”€ bilibili-emoji/
â”‚   â”œâ”€â”€ manifest.json           # æ’ä»¶å…ƒæ•°æ®
â”‚   â”œâ”€â”€ index.js               # ç¼–è¯‘åçš„å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ assets/                # å†…ç½®èµ„æº
â”‚   â””â”€â”€ backend/               # åç«¯ï¼ˆå¯é€‰ï¼‰
â”‚       â”œâ”€â”€ plugin.dll         # Windows
â”‚       â”œâ”€â”€ libplugin.dylib    # macOS
â”‚       â””â”€â”€ libplugin.so       # Linux
â””â”€â”€ other-plugin/
    â””â”€â”€ ...

ç”¨æˆ·æ•°æ®ç›®å½•ä½ç½®ï¼š
- Windows: %APPDATA%/YourApp/plugins
- macOS: ~/Library/Application Support/YourApp/plugins
- Linux: ~/.config/yourapp/plugins
```

### è·¯å¾„ç®¡ç†å®ç°

å½“å‰æ¶æ„ä½¿ç”¨ **PackageManager** è¿›è¡Œè·¯å¾„ç®¡ç†ï¼š

```typescript
// é€šè¿‡ PluginContext è®¿é—®è·¯å¾„
export interface PluginContext {
  // è·å–åº”ç”¨æ•°æ®ç›®å½•
  getAppDataDir: () => Promise<string>
  
  // æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
  fs: {
    readDir: (path: string) => Promise<Array<{name: string, isFile: boolean, isDirectory: boolean}>>
    readFile: (path: string) => Promise<string>
    writeFile: (path: string, content: string | Uint8Array) => Promise<void>
    exists: (path: string) => Promise<boolean>
    mkdir: (path: string, options?: {recursive?: boolean}) => Promise<void>
    remove: (path: string) => Promise<void>
  }
}

// PackageManager å†…éƒ¨è·¯å¾„ç®¡ç†
export class PluginPackageManager {
  private pluginsDir: string = ''  // æ’ä»¶å®‰è£…ç›®å½•
  
  async initialize(): Promise<void> {
    const appData = await appDataDir()
    this.pluginsDir = await join(appData, 'plugins')
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    if (!await exists(this.pluginsDir)) {
      await mkdir(this.pluginsDir, { recursive: true })
    }
  }
}
```

### æ’ä»¶ä¸­çš„è·¯å¾„ä½¿ç”¨

```typescript
// æ’ä»¶ä»£ç ç¤ºä¾‹
export default definePlugin({
  async onLoad(context) {
    // è·å–åº”ç”¨æ•°æ®ç›®å½•
    const appDataDir = await context.getAppDataDir()
    
    // åˆ›å»ºæ’ä»¶ä¸“ç”¨ç›®å½•
    const pluginDataDir = `${appDataDir}/my-plugin-data`
    await context.fs.mkdir(pluginDataDir, { recursive: true })
    
    // è¯»å†™æ–‡ä»¶
    const configPath = `${pluginDataDir}/config.json`
    if (await context.fs.exists(configPath)) {
      const config = await context.fs.readFile(configPath)
      // å¤„ç†é…ç½®
    }
  }
})
```

## ğŸ”„ è¿è¡Œæ—¶æœºåˆ¶

### æ’ä»¶åŠ è½½æµç¨‹

```
åº”ç”¨å¯åŠ¨
  â†“
åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿ
  â†“
æ‰«ææ’ä»¶ç›®å½•
  â†“
è¯»å–æ¯ä¸ªæ’ä»¶çš„ manifest.json
  â†“
åŠ è½½å·²å¯ç”¨çš„æ’ä»¶
  â†“
è¯»å– index.js æ–‡ä»¶å†…å®¹
  â†“
ä½¿ç”¨ Function æ„é€ å™¨æ‰§è¡Œä»£ç 
  â†“
è·å– PluginDefinition
  â†“
åˆ›å»º PluginContext
  â†“
è°ƒç”¨ onLoad(context)
  â†“
æ’ä»¶é€šè¿‡ context API æ“ä½œåº”ç”¨
```

### ç»„ä»¶æ³¨å…¥å®ç°

**è¿è¡Œæ—¶åŠ¨æ€åŒ…è£…**ï¼š
- æ’ä»¶é€šè¿‡ `context.injectComponent()` æ³¨å†Œæ³¨å…¥ä¿¡æ¯
- ComponentInjectionManager ç®¡ç†æ‰€æœ‰æ³¨å…¥
- å½“ç›®æ ‡ç»„ä»¶æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨åŒ…è£…å®ƒ
- åŒ…è£…åçš„ç»„ä»¶åœ¨æ¸²æŸ“æ—¶åŠ¨æ€æ’å…¥æ³¨å…¥çš„ç»„ä»¶

```typescript
// æ’ä»¶ä»£ç 
context.injectComponent('ChatWindow', MyComponent, {
  position: 'after'
})

// è¿è¡Œæ—¶å¤„ç†
const wrapped = defineComponent({
  setup(props, { slots, attrs }) {
    return () => {
      const children = []
      
      // Before æ³¨å…¥
      getInjections('ChatWindow')
        .filter(i => i.position === 'before')
        .forEach(i => children.push(h(i.component, i.props)))
      
      // åŸå§‹ç»„ä»¶
      children.push(h(original, { ...props, ...attrs }, slots))
      
      // After æ³¨å…¥
      getInjections('ChatWindow')
        .filter(i => i.position === 'after')
        .forEach(i => children.push(h(i.component, i.props)))
      
      return h('div', children)
    }
  }
})
```

### çƒ­åŠ è½½æœºåˆ¶

```typescript
// åŠ è½½æ’ä»¶
await pluginLoader.loadPlugin('my-plugin')
// âœ… ç»„ä»¶æ³¨å…¥ç«‹å³ç”Ÿæ•ˆ

// å¸è½½æ’ä»¶
await pluginLoader.unloadPlugin('my-plugin')
// âœ… ç»„ä»¶æ³¨å…¥è‡ªåŠ¨ç§»é™¤
// âœ… æ¢å¤åŸå§‹ç»„ä»¶ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–æ³¨å…¥ï¼‰

// å®Œå…¨ç§»é™¤æ’ä»¶
await pluginLoader.removePlugin('my-plugin')
// âœ… åˆ é™¤æ’ä»¶æ–‡ä»¶
// âœ… å‘é€è·¨çª—å£äº‹ä»¶é€šçŸ¥å…¶ä»–çª—å£
```

## ğŸ”Œ æ’ä»¶API

### PluginContext æ¥å£

```typescript
interface PluginContext {
  // Vueæ ¸å¿ƒ
  app: App
  router: Router
  getStore: (name: string) => Store
  
  // Hook API
  hookComponent: (name, hooks) => UnhookFunction
  hookStore: (name, hooks) => UnhookFunction
  hookService: (path, func, hooks) => UnhookFunction
  
  // ç»„ä»¶æ³¨å…¥
  injectComponent: (target, component, options) => UnhookFunction
  wrapComponent: (name, wrapper) => UnhookFunction
  
  // è·¯ç”±
  addRoute: (route) => void
  
  // é…ç½®
  getConfig: <T>(key, defaultValue?) => T
  setConfig: (key, value) => Promise<void>
  
  // Tauriå‘½ä»¤
  invokeTauri: <T>(command, args?) => Promise<T>
  
  // æ’ä»¶é—´é€šä¿¡
  on: (event, handler) => UnsubscribeFunction
  emit: (event, ...args) => void
  sendMessage: (to, type, data) => string
  registerRPC: (method, handler) => UnregisterFunction
  callRPC: (plugin, method, ...params) => Promise<any>
  
  // LLMå·¥å…·
  registerTool: (tool) => UnregisterFunction
  callTool: (name, args) => Promise<any>
  getAvailableTools: () => ToolInfo[]
  
  // DOMæ³¨å…¥
  injectHTML: (selector, html, options?) => UnhookFunction
  injectVueComponent: (selector, component, props?, options?) => Promise<UnhookFunction>
  injectCSS: (css, options?) => UnhookFunction
  
  // è°ƒè¯•
  debug: (...args) => void
}
```

### æ’ä»¶å®šä¹‰ç¤ºä¾‹

```typescript
import { definePlugin } from '@/pluginLoader/core/pluginApi'

export default definePlugin({
  name: 'example-plugin',
  version: '1.0.0',
  description: 'ç¤ºä¾‹æ’ä»¶',
  
  async onLoad(context) {
    // 1. Hookç»„ä»¶
    context.hookComponent('ChatWindow', {
      mounted(instance) {
        console.log('èŠå¤©çª—å£å·²æŒ‚è½½')
      }
    })
    
    // 2. Hook Store
    context.hookStore('chatStore', {
      afterAction(name, args, result) {
        if (name === 'sendMessage') {
          console.log('æ¶ˆæ¯å·²å‘é€:', args[0])
        }
      }
    })
    
    // 3. æ³¨å…¥ç»„ä»¶
    context.injectComponent('ChatWindow', MyCustomButton, {
      position: 'after',
      props: { label: 'è‡ªå®šä¹‰æŒ‰é’®' }
    })
    
    // 4. æ·»åŠ è·¯ç”±
    context.addRoute({
      path: '/plugin/example',
      component: MyPluginPage
    })
    
    // 5. æ³¨å†ŒLLMå·¥å…·
    context.registerTool({
      name: 'my_tool',
      description: 'æˆ‘çš„å·¥å…·',
      parameters: [
        {
          name: 'input',
          type: 'string',
          description: 'è¾“å…¥å‚æ•°',
          required: true
        }
      ],
      handler: async (args) => {
        return `å¤„ç†ç»“æœ: ${args.input}`
      },
      category: 'utility',
      examples: ['my_tool({"input": "hello world"})']
    })
    
    // 6. åç«¯äº¤äº’ç¤ºä¾‹
    if (context.getConfig('enableBackend')) {
      try {
        // HTTPè¯·æ±‚ï¼ˆé¿å…CORSé™åˆ¶ï¼‰
        const apiResponse = await context.invokeTauri<string>('http_request', {
          url: 'https://api.example.com/search',
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'User-Agent': 'MyPlugin/1.0'
          },
          body: JSON.stringify({ query: 'test' })
        })
        
        const data = JSON.parse(apiResponse)
        context.debug('APIå“åº”:', data)
        
        // æ–‡ä»¶æ“ä½œç¤ºä¾‹
        const appDataDir = await context.getAppDataDir()
        const cacheDir = `${appDataDir}/my-plugin-cache`
        
        // ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨
        await context.fs.mkdir(cacheDir, { recursive: true })
        
        // ä¿å­˜æ•°æ®åˆ°ç¼“å­˜
        const cacheFile = `${cacheDir}/api-cache.json`
        await context.fs.writeFile(cacheFile, JSON.stringify(data))
        
        // è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ï¼‰
        if (data.imageUrl) {
          const imageResponse = await context.invokeTauri<string>('http_request', {
            url: data.imageUrl,
            method: 'GET'
          })
          
          // ä¿å­˜å›¾ç‰‡
          const imagePath = `${cacheDir}/image.png`
          await context.fs.writeFile(imagePath, imageResponse)
        }
        
      } catch (error) {
        context.debug('åç«¯è°ƒç”¨å¤±è´¥:', error)
      }
    }
  },
  
  async onUnload(context) {
    context.debug('æ’ä»¶å¸è½½')
    // Hookä¼šè‡ªåŠ¨æ¸…ç†
  }
})
```

### å®é™…æ’ä»¶åç«¯äº¤äº’æ¡ˆä¾‹

ä»¥ä¸‹æ˜¯ `bilibili-emoji` æ’ä»¶çš„å®é™…åç«¯äº¤äº’ç¤ºä¾‹ï¼š

```typescript
// æœç´¢Bç«™è£…æ‰®
const searchSuits = async (keyword: string) => {
  try {
    const url = `https://api.bilibili.com/x/garb/v2/mall/home/search?key_word=${encodeURIComponent(keyword)}`
    
    // é€šè¿‡ä¸»åº”ç”¨HTTPå‘½ä»¤å‘é€è¯·æ±‚ï¼ˆé¿å…CORSï¼‰
    const responseText = await context.invokeTauri<string>('http_request', {
      url,
      method: 'GET',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Referer': 'https://www.bilibili.com/'
      }
    })
    
    const response = JSON.parse(responseText)
    return response.data?.list || []
  } catch (error) {
    context.debug('æœç´¢å¤±è´¥:', error)
    return []
  }
}

// ä¸‹è½½è¡¨æƒ…åŒ…æ–‡ä»¶
const downloadEmoji = async (url: string, savePath: string) => {
  try {
    // ä¸‹è½½æ–‡ä»¶å†…å®¹
    const content = await context.invokeTauri<number[]>('read_binary_file', {
      path: url // è¿™é‡Œå®é™…ä¸Šæ˜¯é€šè¿‡HTTPä¸‹è½½
    })
    
    // ä¿å­˜åˆ°æœ¬åœ°
    const uint8Array = new Uint8Array(content)
    await context.fs.writeFile(savePath, uint8Array)
    
    return true
  } catch (error) {
    context.debug('ä¸‹è½½å¤±è´¥:', error)
    return false
  }
}

// æ¸…ç†ä¸´æ—¶æ–‡ä»¶
const cleanupTemp = async (tempDir: string) => {
  try {
    await context.invokeTauri('remove_dir_all', { path: tempDir })
    context.debug('ä¸´æ—¶ç›®å½•å·²æ¸…ç†')
  } catch (error) {
    context.debug('æ¸…ç†å¤±è´¥:', error)
  }
}
```

## ğŸ”’ å®‰å…¨æœºåˆ¶

### æƒé™ç³»ç»Ÿ

æ’ä»¶å¿…é¡»åœ¨manifest.jsonä¸­å£°æ˜æƒé™ï¼š

```json
{
  "id": "com.example.myplugin",
  "name": "My Plugin",
  "version": "1.0.0",
  "permissions": [
    "hook:component",      // Hook Vueç»„ä»¶
    "hook:store",          // Hook Pinia Store
    "hook:service",        // HookæœåŠ¡å‡½æ•°
    "network",             // ç½‘ç»œè®¿é—®
    "filesystem:read",     // æ–‡ä»¶ç³»ç»Ÿè¯»å–
    "filesystem:write",    // æ–‡ä»¶ç³»ç»Ÿå†™å…¥
    "clipboard",           // å‰ªè´´æ¿è®¿é—®
    "notification"         // é€šçŸ¥
  ],
  "dependencies": {
    "other-plugin": "^1.0.0"
  },
  "backend": {
    "enabled": true,
    "entry": "backend/plugin.dll",
    "commands": ["my_command", "another_command"]
  },
  "config": {
    "apiKey": {
      "type": "string",
      "default": "",
      "description": "APIå¯†é’¥"
    }
  }
}
```

### æ²™ç®±éš”ç¦»

1. **ä»£ç éš”ç¦»**
   - æ’ä»¶ä»£ç åœ¨ç‹¬ç«‹ä½œç”¨åŸŸæ‰§è¡Œ
   - åªèƒ½é€šè¿‡PluginContextè®¿é—®ä¸»åº”ç”¨

2. **èµ„æºé™åˆ¶**
   - é™åˆ¶å†…å­˜ä½¿ç”¨
   - é™åˆ¶CPUæ—¶é—´
   - é™åˆ¶ç½‘ç»œè¯·æ±‚é¢‘ç‡

3. **APIé™åˆ¶**
   - æ ¹æ®æƒé™æ§åˆ¶APIè®¿é—®
   - æ•æ„Ÿæ“ä½œéœ€è¦ç”¨æˆ·ç¡®è®¤

## ğŸ”§ åç«¯æ¶æ„

### RuståŠ¨æ€åº“æ–¹å¼

**ä¼˜åŠ¿**ï¼š
- æ€§èƒ½æœ€ä½³ï¼Œç›´æ¥å†…å­˜è°ƒç”¨
- ä¸ä¸»åº”ç”¨å…±äº«è¿›ç¨‹
- æ— éœ€é¢å¤–ç«¯å£

**å®ç°æ–¹å¼**ï¼š

1. **æ’ä»¶åç«¯ä»£ç ï¼ˆRustï¼‰**
```rust
// backend/src/lib.rs
use serde::{Deserialize, Serialize};

#[derive(Debug, Serialize, Deserialize)]
pub struct ProcessResult {
    pub success: bool,
    pub data: String,
    pub error: Option<String>,
}

// æ’ä»¶åˆå§‹åŒ–å‡½æ•°
#[no_mangle]
pub extern "C" fn plugin_init() {
    println!("[Plugin] Backend initialized");
}

// æ’ä»¶æ¸…ç†å‡½æ•°
#[no_mangle]
pub extern "C" fn plugin_cleanup() {
    println!("[Plugin] Backend cleaned up");
}

// æ’ä»¶ä¸šåŠ¡é€»è¾‘å‡½æ•°
pub fn process_data(input: &str) -> ProcessResult {
    ProcessResult {
        success: true,
        data: format!("Processed: {}", input),
        error: None,
    }
}
```

2. **ä¸»åº”ç”¨åŠ è½½åŠ¨æ€åº“ï¼ˆRustï¼‰**
```rust
// src-tauri/src/plugin_manager.rs
use libloading::{Library, Symbol};

pub struct PluginBackend {
    library: Library,
    commands: Vec<String>,
}

impl PluginBackend {
    pub fn load(path: &str) -> Result<Self, String> {
        unsafe {
            let lib = Library::new(path)
                .map_err(|e| format!("åŠ è½½å¤±è´¥: {}", e))?;
            
            // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
            if let Ok(init_fn) = lib.get::<extern "C" fn()>(b"plugin_init") {
                init_fn();
            }
            
            Ok(PluginBackend {
                library: lib,
                commands: vec![],
            })
        }
    }
}
```

### ä¸»åº”ç”¨æä¾›çš„é€šç”¨åç«¯å‘½ä»¤

æ’ä»¶é€šè¿‡ä»¥ä¸‹é€šç”¨å‘½ä»¤ä¸åç«¯äº¤äº’ï¼š

#### HTTPè¯·æ±‚å‘½ä»¤
```typescript
// å‘é€HTTPè¯·æ±‚ï¼ˆé¿å…CORSé™åˆ¶ï¼‰
const response = await context.invokeTauri<string>('http_request', {
    url: 'https://api.example.com/data',
    method: 'GET', // GET, POST, PUT, DELETE
    headers: {
        'User-Agent': 'MyApp/1.0',
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ key: 'value' }) // å¯é€‰
})
```

#### æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤
```typescript
// è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶
const bytes = await context.invokeTauri<number[]>('read_binary_file', {
    path: '/path/to/image.png'
})

// é€’å½’åˆ é™¤ç›®å½•
await context.invokeTauri('remove_dir_all', {
    path: '/temp/directory'
})
```

#### æ’ä»¶ç®¡ç†å‘½ä»¤
```typescript
// è¿™äº›å‘½ä»¤ç”±æ’ä»¶ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨
await context.invokeTauri('plugin_load_backend', {
    pluginId: 'my-plugin',
    backendPath: '/path/to/plugin.dll'
})

await context.invokeTauri('plugin_unload_backend', {
    pluginId: 'my-plugin'
})
```

### å‰åç«¯é€šä¿¡æµç¨‹

**å½“å‰å®ç°çš„é€šä¿¡æ–¹å¼**ï¼š

```
å‰ç«¯æ’ä»¶
   â”‚
   â”‚ 1. context.invokeTauri('http_request', {url, method, headers})
   â†“
Tauri IPC å±‚
   â”‚
   â”‚ 2. ä¸»åº”ç”¨é€šç”¨å‘½ä»¤å¤„ç†
   â†“
ä¸»åº”ç”¨åç«¯ (Rust)
   â”‚
   â”‚ 3. æ‰§è¡ŒHTTPè¯·æ±‚/æ–‡ä»¶æ“ä½œç­‰
   â†“
è¿”å›ç»“æœ
   â”‚
   â”‚ 4. é€šè¿‡IPCè¿”å›
   â†“
å‰ç«¯æ’ä»¶æ¥æ”¶ç»“æœ
```

**æ’ä»¶åç«¯åŠ¨æ€åº“çš„ä½œç”¨**ï¼š
- ä¸»è¦ç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘
- é€šè¿‡ `plugin_init()` å‡½æ•°è¿›è¡Œåˆå§‹åŒ–
- ç›®å‰ä¸»è¦é€šè¿‡ä¸»åº”ç”¨æä¾›çš„é€šç”¨å‘½ä»¤é—´æ¥è°ƒç”¨

## ğŸ› ï¸ å¼€å‘å·¥å…·

### CLIå·¥å…· (plugin-cli)

```bash
# åˆ›å»ºæ’ä»¶
plugin-cli create my-plugin

# æ„å»ºæ’ä»¶
plugin-cli build my-plugin

# éªŒè¯æ’ä»¶
plugin-cli validate my-plugin

# æ‰“åŒ…æ’ä»¶
plugin-cli package my-plugin

# åˆ—å‡ºæ’ä»¶
plugin-cli list
```

### ç¬¦å·æ‰«æå™¨ (symbolScanner)

è‡ªåŠ¨æ‰«æä¸»åº”ç”¨ï¼Œç”Ÿæˆå¯Hookçš„ç¬¦å·åˆ—è¡¨ï¼š

```bash
npm run plugin:scan
```

ç”Ÿæˆ `symbol-map.json`ï¼š
```json
{
  "components": [
    {
      "name": "ChatWindow",
      "path": "src/components/ChatWindow.vue",
      "props": ["messages", "user"],
      "emits": ["send", "close"],
      "methods": ["scrollToBottom", "clearInput"]
    }
  ],
  "stores": [
    {
      "name": "chatStore",
      "path": "src/stores/chat.ts",
      "state": ["messages", "currentUser"],
      "actions": ["sendMessage", "loadHistory"]
    }
  ]
}
```

## ğŸš€ éƒ¨ç½²æµç¨‹

### æ’ä»¶å¼€å‘

```bash
# 1. åˆ›å»ºæ’ä»¶
cd pluginLoader
node tools/plugin-cli.js create my-plugin

# 2. å¼€å‘æ’ä»¶
cd plugins/my-plugin
# ç¼–è¾‘ index.ts

# 3. æ„å»ºæ’ä»¶
npm run build

# 4. éªŒè¯æ’ä»¶
node tools/plugin-cli.js validate my-plugin

# 5. æ‰“åŒ…æ’ä»¶
node tools/plugin-cli.js package my-plugin
# ç”Ÿæˆ my-plugin-1.0.0.zip
```

### æ’ä»¶å®‰è£…

**æ–¹å¼1ï¼šæœ¬åœ°å®‰è£…**
```typescript
await pluginLoader.installPlugin('/path/to/plugin.zip')
await pluginLoader.loadPlugin('com.example.myplugin')
```

**æ–¹å¼2ï¼šUIå®‰è£…**
- åœ¨è®¾ç½®é¡µé¢é€‰æ‹©æ’ä»¶åŒ…æ–‡ä»¶
- è‡ªåŠ¨å®‰è£…å’Œå¯ç”¨
- æ˜¾ç¤ºå®‰è£…ç»“æœå’Œé€šçŸ¥

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ‡’åŠ è½½

- æ’ä»¶æŒ‰éœ€åŠ è½½
- åç«¯å»¶è¿Ÿåˆå§‹åŒ–
- ç»„ä»¶åŠ¨æ€å¯¼å…¥

### ç¼“å­˜æœºåˆ¶

- æ’ä»¶ä»£ç ç¼“å­˜
- é…ç½®ç¼“å­˜
- ç¬¦å·æ˜ å°„ç¼“å­˜

### å¹¶å‘æ§åˆ¶

- é™åˆ¶åŒæ—¶åŠ è½½çš„æ’ä»¶æ•°é‡
- å¼‚æ­¥åŠ è½½ä¼˜åŒ–
- é˜²æ­¢é˜»å¡ä¸»çº¿ç¨‹

## ğŸ” é”™è¯¯å¤„ç†

### æ’ä»¶åŠ è½½å¤±è´¥

```typescript
try {
  await pluginLoader.loadPlugin('my-plugin')
} catch (error) {
  // æ˜¾ç¤ºé”™è¯¯æç¤º
  // è®°å½•æ—¥å¿—
  // å›æ»šçŠ¶æ€
}
```

### è¿è¡Œæ—¶é”™è¯¯

- Hookæ‰§è¡Œé”™è¯¯ä¸å½±å“ä¸»åº”ç”¨
- è‡ªåŠ¨æ•è·å¹¶è®°å½•
- æä¾›é”™è¯¯æ¢å¤æœºåˆ¶

### åç«¯å´©æºƒ

- è‡ªåŠ¨é‡å¯åç«¯
- é™çº§åˆ°çº¯å‰ç«¯æ¨¡å¼
- é€šçŸ¥ç”¨æˆ·

## ğŸ“‹ æ€»ç»“

æœ¬æ’ä»¶ç³»ç»Ÿè®¾è®¡å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **çµæ´»æ€§** - æ”¯æŒçº¯å‰ç«¯å’Œæ··åˆæ’ä»¶
2. **å®‰å…¨æ€§** - æƒé™æ§åˆ¶å’Œæ²™ç®±éš”ç¦»
3. **æ€§èƒ½** - RuståŠ¨æ€åº“ï¼Œé›¶å¼€é”€æŠ½è±¡
4. **æ˜“ç”¨æ€§** - ä¸°å¯Œçš„APIå’Œå¼€å‘å·¥å…·
5. **å¯æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
6. **ç”Ÿäº§å°±ç»ª** - å®Œæ•´çš„è·¯å¾„ç®¡ç†å’Œéƒ¨ç½²æ–¹æ¡ˆ

é€šè¿‡è¿™å¥—æœºåˆ¶ï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾æ‰©å±•åº”ç”¨åŠŸèƒ½ï¼Œè€Œä¸å½±å“æ ¸å¿ƒç¨³å®šæ€§ã€‚æ’ä»¶ç³»ç»Ÿå·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œï¼Œæ”¯æŒçƒ­æ’æ‹”ã€è·¨çª—å£é€šä¿¡ã€LLMå·¥å…·é›†æˆç­‰é«˜çº§åŠŸèƒ½ã€‚

---

**ğŸ‰ è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ’ä»¶ç³»ç»Ÿæ¶æ„ï¼**