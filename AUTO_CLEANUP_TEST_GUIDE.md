# 自动清理系统测试指南

## 🎯 测试目标

验证插件加载器的**自动清理系统**是否正常工作，确保使用 `injectComponent` 的插件在卸载时能自动清理，无需手动刷新页面。

## 🧪 测试插件

**hook-test** 插件已更新为测试版本，包含：

1. **DOM 直接注入** - 紫色文本框（顶部20px）
   - 文本：`✨ hook组件成功 (DOM)`
   - 需要插件手动清理

2. **Vue 组件注入** - 粉色文本框（顶部60px）
   - 文本：`✨ hook组件成功 (Vue组件注入)`
   - 应该由系统自动清理

## 📋 测试步骤

### 1. 刷新浏览器

```bash
# 按 F5 或 Ctrl+R
```

### 2. 启用插件

1. 打开设置 → 插件管理
2. 找到 "Hook测试插件"
3. 点击开关启用

**预期结果**:
- ✅ 看到两个文本框：
  - 紫色（顶部）：DOM 注入
  - 粉色（下方）：Vue 组件注入
- ✅ 控制台显示：
  ```
  🚀 Hook测试插件加载中...
  📝 测试目标：验证自动清理系统
  ✅ Hook测试样式已注入
  ✅ DOM元素已注入到当前窗口
  ✅ Vue组件注入已设置
  📌 注意：禁用插件时，Vue组件注入应该自动清理（无需刷新）
  🎉 Hook测试插件加载完成
  💡 提示：禁用插件后观察是否需要刷新页面
  ```

### 3. 禁用插件

1. 在插件管理中
2. 点击开关禁用插件
3. **不要刷新页面**
4. 观察文本框是否消失

**预期结果**:
- ✅ 两个文本框都应该立即消失
- ✅ 控制台显示：
  ```
  🔴 [Hook-Test] onUnload 开始执行
  🧹 Hook测试插件卸载中...
  ✅ [Hook-Test] DOM元素已移除
  ✅ [Hook-Test] 样式已移除
  📊 [Hook-Test] 清理验证:
    - DOM元素: ✅ 已清理
    - Vue组件元素数量: 0
  ✅ [Hook-Test] 所有元素已清理（包括Vue组件注入）
  🎉 [Hook-Test] 完美！自动清理系统工作正常
  ```

### 4. 验证清理

**检查点**:
- [ ] 紫色文本框消失
- [ ] 粉色文本框消失
- [ ] 控制台显示 "🎉 完美！自动清理系统工作正常"
- [ ] 没有错误信息

### 5. 重新启用

1. 再次启用插件
2. 验证是否正常工作

**预期结果**:
- ✅ 两个文本框重新出现
- ✅ 没有冲突或错误

### 6. 多次循环测试

重复启用/禁用 3-5 次，验证稳定性。

## 🔍 故障排查

### 问题1: Vue 组件注入未清理

**症状**:
```
❌ [Hook-Test] Vue组件注入未被自动清理！
❌ [Hook-Test] 自动清理系统可能有问题
```

**原因**:
- 路由刷新未触发
- 组件未重新渲染

**解决**:
1. 检查 `pluginLoader/core/pluginLoader.ts` 中的 `forceRefreshCurrentRoute` 方法
2. 检查 `pluginLoader/core/componentInjection.ts` 中的 `triggerComponentRefresh` 方法
3. 查看浏览器控制台是否有错误

### 问题2: DOM 元素未清理

**症状**:
```
📊 [Hook-Test] 清理验证:
  - DOM元素: ❌ 仍存在
```

**原因**:
- `onUnload` 未正确执行
- DOM 操作失败

**解决**:
1. 检查 `onUnload` 是否被调用
2. 检查元素 ID 是否正确
3. 查看是否有 JavaScript 错误

### 问题3: 需要刷新页面

**症状**:
- 禁用插件后文本框仍然存在
- 刷新页面后才消失

**原因**:
- 自动清理系统未工作
- 路由刷新失败

**解决**:
1. 确认已应用最新的代码更改
2. 检查 `componentInjectionManager.cleanupPlugin` 是否被调用
3. 检查 `forceRefreshCurrentRoute` 是否执行

## 📊 测试矩阵

| 操作 | DOM 注入 | Vue 组件注入 | 需要刷新 | 状态 |
|------|---------|-------------|---------|------|
| 启用插件 | ✅ 显示 | ✅ 显示 | ❌ 否 | 待测试 |
| 禁用插件 | ✅ 清理 | ✅ 自动清理 | ❌ 否 | 待测试 |
| 重新启用 | ✅ 显示 | ✅ 显示 | ❌ 否 | 待测试 |
| 多次循环 | ✅ 稳定 | ✅ 稳定 | ❌ 否 | 待测试 |

## 🎓 理解测试

### DOM 注入 vs Vue 组件注入

**DOM 注入**:
```typescript
const element = document.createElement('div')
document.body.appendChild(element)
```
- 直接操作 DOM
- 需要插件手动清理
- 简单直接

**Vue 组件注入**:
```typescript
context.injectComponent('MyComponent', InjectedComponent, {
    position: 'before'
})
```
- 在 Vue 组件树中注入
- 由系统自动清理
- 更优雅，但需要系统支持

### 自动清理流程

```
禁用插件
  ↓
plugin.onUnload() 执行
  ├─ 插件清理 DOM 元素
  └─ 插件清理其他资源
  ↓
componentInjectionManager.cleanupPlugin()
  ├─ 移除插件的组件注入
  ├─ 发送刷新事件
  └─ 清除包装组件缓存
  ↓
forceRefreshCurrentRoute()
  ├─ 添加临时 _refresh 参数
  ├─ 触发路由重新渲染
  └─ 移除临时参数
  ↓
组件重新渲染
  └─ 不包含已卸载插件的注入
  ↓
完成
```

## ✅ 成功标志

当看到以下情况时，说明自动清理系统工作正常：

1. **禁用插件后**
   - ✅ 两个文本框立即消失
   - ✅ 无需刷新页面
   - ✅ 控制台显示 "🎉 完美！自动清理系统工作正常"

2. **重新启用后**
   - ✅ 两个文本框重新出现
   - ✅ 没有冲突或重复

3. **多次循环后**
   - ✅ 每次都正常工作
   - ✅ 没有累积的问题

## 🎉 测试完成

如果所有测试都通过，说明：
- ✅ 自动清理系统工作正常
- ✅ 所有使用 `injectComponent` 的插件都能受益
- ✅ 用户体验得到改善

---

**现在开始测试吧！** 🚀

刷新浏览器，启用 hook-test 插件，然后禁用它，观察是否需要刷新页面。
